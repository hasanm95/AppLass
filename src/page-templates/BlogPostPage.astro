---
import Layout from '../layouts/Layout.astro';
import { getImage } from 'astro:assets';
import appLogoImg from '@/assets/logo.png';
import { Navbar, Footer } from "@/components/common";
import { AppCallout } from "@/components/blog/AppCallout";
import { ShareArticle } from "@/components/blog/ShareArticle";
import { ReadingProgressBar } from "@/components/blog/ReadingProgressBar";
import { FAQSchema } from "@/components/common/FAQSchema";
import { getBlogPostBySlug } from "@/lib/blog";
import { getDictionary } from "@/i18n/get-dictionary";
import { i18nConfig } from "@/i18n/config";
import { render } from "astro:content";
import { ArrowLeft } from "lucide-react";
import { localePath } from "@/i18n/utils";

interface Props {
  lang: typeof i18nConfig.locales[number];
  slug: string;
}

const { lang, slug } = Astro.props;
const dict = await getDictionary(lang as any);
const post = await getBlogPostBySlug(slug as string, lang as string);

if (!post || !post.entry) {
  return Astro.redirect('/404');
}

const { Content } = await render(post.entry);

const title = `${post.title} | AppLass Blog`;
const description = post.excerpt;

const optimizedAppLogo = await getImage({ src: appLogoImg, format: 'webp', width: 64, height: 64 });
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  description: post.excerpt,
  image: typeof post.thumbnail === 'object' ? post.thumbnail.src : post.thumbnail,
  datePublished: post.date,
  author: {
    "@type": "Person",
    name: post.author,
  },
  publisher: {
    "@type": "Organization",
    name: "AppLass",
    logo: {
      "@type": "ImageObject",
      url: new URL(optimizedAppLogo.src, Astro.site).href,
    },
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `https://applass.com/${lang}/blog/${slug}`,
  },
};


---

<Layout title={title} description={description} lang={lang}>
  <script
    type="application/ld+json"
    is:inline
    set:html={JSON.stringify(jsonLd)}
  />
  {post.faqs && post.faqs.length > 0 && (
    <FAQSchema
      items={post.faqs as { question: string; answer: string }[]}
    />
  )}
  <ReadingProgressBar client:load />
  <Navbar client:load translations={dict.nav} currentLang={lang}  logoSrc={optimizedAppLogo.src} />
  
  <div class="flex-1 bg-white pt-20">
    <header class="bg-iridescent relative border-b border-slate-100 pt-20 pb-15 lg:py-32">
      <div class="section-container relative z-10">
        <a
          href={localePath(lang, "/blog")}
          class="mb-12 inline-flex items-center gap-2 text-xs font-black tracking-widest text-blue-800 uppercase transition-transform hover:-translate-x-1"
        >
          <ArrowLeft className="h-4 w-4" aria-hidden="true" />
          {lang === 'fr' ? 'Retour aux archives' : 'Back to Archive'}
        </a>

        <div class="mb-8 flex items-center gap-3">
          <span class="rounded-full bg-emerald-500/10 px-4 py-1.5 text-[10px] font-black tracking-widest text-emerald-800 uppercase">
            {post.category}
          </span>
          <span class="h-1 w-1 rounded-full bg-slate-200" />
          <span class="text-[10px] font-bold text-slate-500">
            {post.date}
          </span>
        </div>

        <h1 class="mb-10 max-w-6xl text-2xl leading-[1.2] font-bold text-slate-900 lg:text-8xl">
          {post.title}
        </h1>

        <div class="flex items-center gap-4">
          <div class="flex h-12 w-12 items-center justify-center rounded-full bg-slate-900 text-xs font-bold text-white">
            {post.author
              .split(" ")
              .map((n) => n[0])
              .join("")}
          </div>
          <div>
            <p class="text-sm font-black text-slate-900">
              {post.author}
            </p>
            <p class="text-xs font-bold text-slate-500">
              {lang === 'fr' ? 'Auteur de l\'article' : 'Article Author'}
            </p>
          </div>
        </div>
      </div>
    </header>

    <section class="section group relative py-15 lg:py-24">
      <div class="section-container">
        <div class="flex flex-col gap-16 lg:flex-row">
          <article class="lg:w-2/3">
            <div 
              class="prose prose-slate prose-lg prose-headings:font-black prose-headings:tracking-tight prose-headings:text-slate-900 prose-p:text-slate-600 prose-p:leading-relaxed prose-p:font-medium prose-strong:text-slate-900 prose-strong:font-black prose-a:text-blue-600 prose-a:font-bold hover:prose-a:text-blue-700 prose-img:rounded-4xl prose-img:border prose-img:border-slate-100 max-w-none"
            >
              <Content />
            </div>
          </article>

          <aside class="lg:w-1/3">
            <div class="sticky top-32 flex flex-col gap-8">
              <AppCallout appName="Mindful Guard" lang={lang} />
              <AppCallout appName="FOMOgen" lang={lang} />
              <ShareArticle title={post.title} slug={slug as string} client:idle />
            </div>
          </aside>
        </div>
      </div>
    </section>

    {post.faqs && post.faqs.length > 0 && (
      <section
        id="faq"
        class="border-t border-slate-200 bg-[#FBFBFA] py-24"
      >
        <div class="section-container">
          <div class="mb-24">
            <span class="mb-6 block font-mono text-[10px] font-bold tracking-[0.3em] text-blue-600 uppercase">
              {lang === 'fr' ? 'Précisions Techniques' : 'Technical Clarifications'}
            </span>
            <h2 class="text-5xl font-black tracking-tighter text-slate-950 md:text-6xl">
              {lang === 'fr' ? 'Questions Fréquemment' : 'Frequently Asked'}
              <br />
              <span class="text-slate-300">{lang === 'fr' ? 'Posées' : 'Questions'}</span>
            </h2>
          </div>

          <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
            {post.faqs.map((faq, idx) => (
              <div
                class="group relative border-2 border-slate-950 bg-white p-10 transition-all hover:bg-slate-50"
              >
                <div class="absolute top-4 right-4 font-mono text-[8px] text-slate-300 uppercase">
                  [ Protocol.Entry_0{idx + 1} ]
                </div>
                <h3 class="mb-6 text-xl leading-tight font-black tracking-tight text-slate-950">
                  {faq.question}
                </h3>
                <p class="leading-relaxed font-medium text-slate-600">
                  {faq.answer}
                </p>
                <div class="mt-8 flex items-center gap-4">
                  <div class="h-px flex-1 bg-slate-100" />
                  <div class="h-2 w-2 bg-blue-600" />
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}
  </div>
  <Footer translations={dict.footer}  logoSrc={optimizedAppLogo.src} />
</Layout>
